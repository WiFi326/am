<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>نظام إدارة الموظفين - واي فاي الوطني</title>
    <link rel="icon" type="image/png" sizes="32x32" href="https://png.pngtree.com/png-vector/20190307/ourmid/pngtree-vector-user-management-icon-png-image_780602.jpg">
    <link rel="icon" type="image/png" sizes="64x64" href="https://png.pngtree.com/png-vector/20190307/ourmid/pngtree-vector-user-management-icon-png-image_780602.jpg">
    <link rel="icon" type="image/png" sizes="192x192" href="https://png.pngtree.com/png-vector/20190307/ourmid/pngtree-vector-user-management-icon-png-image_780602.jpg">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <script src="https://cdn.sheetjs.com/xlsx-0.20.0/package/dist/xlsx.full.min.js"></script>
    
    <!-- إضافة Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
    
    <style>
        /* متغيرات الوضع الفاتح */
        :root {
            --main-color: #2c3e50;
            --secondary-color: #3498db;
            --accent-green: #27ae60;
            --accent-red: #c0392b;
            --hover-effect: rgba(255,255,255,0.1);
            --bg-primary: #f8f9fa;
            --bg-secondary: #ffffff;
            --text-primary: #2c3e50;
            --text-secondary: #34495e;
            --border-color: #ddd;
            --shadow-color: rgba(0,0,0,0.1);
            --tatle-color:  #234d8d;
            --sidebar-color: #0f3460;
        }

        /* متغيرات الوضع الداكن */
        .dark-mode {
            --main-color: #ffffff;
            --secondary-color: #0f3460;
            --accent-green: #166d3b;
            --accent-red: #7e0a02;
            --hover-effect: rgba(255,255,255,0.05);
            --bg-primary: #121212;
            --bg-secondary: #1e1e1e;
            --text-primary: #e0e0e0;
            --text-secondary: #b0b0b0;
            --border-color: #444;
            --shadow-color: rgba(0,0,0,0.3);
            --tatle-color:  #ffffff;
            --sidebar-color: #444;
        }

        * {
            box-sizing: border-box;
            font-family: 'Tajawal', sans-serif;
            transition: background-color 0.3s, color 0.3s, border-color 0.3s;
        }

        body {
            margin: 0;
            padding: 0;
            background: var(--bg-primary);
            color: var(--text-primary);
        }

        .container {
            display: flex;
            min-height: 100vh;
        }

        .tatle {
            font-family: 'Tajawal', sans-serif;
            padding-bottom: 15px;
            margin-bottom: 30px;
            font-size: 28px;
            text-align: center;
            color: var(--tatle-color);
            border-bottom: 3px solid;
        }
        
        /* الشريط الجانبي المتقدم */
        .sidebar {
            width: 280px;
            color: var(--sidebar-color);
            padding: 25px;
            position: fixed;
            top: 0;
            right: 0;
            bottom: 0;
            box-shadow: 3px 0 15px var(--shadow-color);
            flex-direction: column;
            padding-bottom: 100px;
            overflow-y: auto;
            z-index: 1000;
        }

        .sidebar-header {
            text-align: center;
            padding: 20px 0;
            border-bottom: 2px solid var(--secondary-color);
            margin-bottom: 30px;
        }

        .sidebar button {
            width: 100%;
            padding: 15px 25px;
            margin: 12px 0;
            border: none;
            background: linear-gradient(45deg, var(--secondary-color), #2980b9);
            color: white;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 12px;
            font-size: 16px;
        }

        .sidebar button:hover {
            background: linear-gradient(45deg, #2980b9, var(--secondary-color));
            transform: translateX(15px);
            box-shadow: 2px 2px 10px var(--shadow-color);
        }

        /* المحتوى الرئيسي مع تأثيرات متقدمة */
        .content {
            flex: 1;
            padding: 40px;
            background: var(--bg-primary);
            margin-right: 280px;
            overflow-y: auto;
        }

        .section {
            display: none;
            background: var(--bg-secondary);
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 5px 25px var(--shadow-color);
        }

        .section.active {
            display: block;
            animation: slideIn 0.4s ease;
        }

        h2 {
            color: var(--main-color);
            border-bottom: 3px solid var(--secondary-color);
            padding-bottom: 15px;
            margin-bottom: 30px;
            font-size: 28px;
        }

        /* نماذج الإدخال المتطورة */
        .form-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 25px;
            padding: 20px;
            background: var(--bg-primary);
            border-radius: 12px;
            margin-bottom: 30px;
        }

        .form-group {
            position: relative;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            color: var(--main-color);
            font-weight: bold;
        }

        input, select, textarea {
            width: 100%;
            padding: 14px;
            border: 2px solid var(--border-color);
            border-radius: 8px;
            transition: border-color 0.3s ease;
            font-size: 16px;
            background: var(--bg-secondary);
            color: var(--text-primary);
        }

        input:focus, select:focus, textarea:focus {
            border-color: var(--secondary-color);
            outline: none;
            box-shadow: 0 0 8px rgba(52, 152, 219, 0.3);
        }

        /* أزرار متطورة */
        .btn {
            padding: 14px 30px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .btn-primary {
            background: linear-gradient(45deg, var(--secondary-color), #2980b9);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(52, 152, 219, 0.4);
        }

        /* الجداول التفاعلية */
        .data-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 25px;
            background: var(--bg-secondary);
            border-radius: 12px;
            overflow: hidden;
            box-shadow: 0 1px 15px var(--shadow-color);
        }

        .data-table th {
            background: linear-gradient(45deg, var(--main-color), #34495e);
            color: white;
            padding: 18px;
            font-size: 16px;
        }

        .data-table td {
            padding: 15px;
            border-bottom: 1px solid var(--border-color);
            color: var(--text-primary);
        }

        .data-table tr:last-child td {
            border-bottom: none;
        }

        .data-table tr:hover {
            background: rgba(0,0,0,0.05);
        }

        .action-buttons button {
            padding: 6px 12px;
            margin: 0 4px;
            border-radius: 5px;
            font-size: 14px;
        }

        /* نظام التبويبات اليومية */
        .daily-tabs {
            display: flex;
            gap: 5px;
            margin-bottom: 18px;
            flex-wrap: wrap;
        }

        .daily-tab {
            padding: 12px 18px;
            background: #eee;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            border: 2px solid transparent;
            color: #333;
        }

        .daily-tab.active {
            background: var(--secondary-color);
            color: white;
            border-color: var(--secondary-color);
            transform: scale(1.05);
        }

        /* تأثيرات الحركة */
        @keyframes slideIn {
            from { opacity: 0; transform: translateY(30px); }
            to { opacity: 1; transform: translateY(0); }
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        /* التخصيصات الخاصة بأنواع البيانات */
        .violation-badge {
            background: var(--accent-red);
            color: white;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 14px;
        }

        .reward-badge {
            background: var(--accent-green);
            color: white;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 14px;
        }
        
        /* زر تصدير اكسل */
        .export-btn {
            position:fixed ;
            bottom: 30px;
            left: 30px;
            z-index: 100;
        }

        /* قسم البحث */
        .search-input {
            width: 100%;
            padding: 12px 20px;
            border: 2px solid var(--border-color);
            border-radius: 25px;
            font-size: 16px;
            transition: all 0.3s ease;
            margin-bottom: 15px;
            background: var(--bg-secondary);
            color: var(--text-primary);
        }

        .search-input:focus {
            border-color: var(--secondary-color);
            box-shadow: 0 0 15px rgba(52, 152, 219, 0.2);
            outline: none;
        }

        /* إضافة زر التسجيل في الشريط الجانبي */
        .logout-btn {
            position: fixed;
            bottom: 30px;
            right: 65px;
            transform: translateX(-50%) ;
            width: 60px !important;
            height: 60px !important;
            border-radius: 50% !important;
            background: var(--accent-red) !important;
            display: flex !important;
            justify-content: center;
            align-items: center;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.3);
            transition: all 0.3s ease;
            z-index: 100;
            padding: 0 !important;
            margin: 0 !important;
        }

        .logout-btn:hover {
            transform: translateX(-50%) !important;
            box-shadow: 0 6px 15px rgba(0, 0, 0, 0.4) !important;
            background: linear-gradient(45deg, #666c83, #666c83) !important;
        }

        .logout-btn i {
            font-size: 24px;
            margin: 0 !important;
        }

        /*  قسم الزمنيات */
        .break-row td {
            background: rgba(0,0,0,0.03);
            transition: background 0.3s ease;
        }

        .break-row:hover td {
            background: rgba(0,0,0,0.07);
        }

        #breakDuration {
            text-align: left;
            direction: ltr;
            padding-right: 45px;
        }

        /* زر تبديل الوضع الداكن */
        .theme-toggle {
            position: absolute;
            top: 20px;
            right: 20px;
            background: rgba(255,255,255,0.1);
            border: none;
            border-radius: 50% !important;
            width: 30px !important;
            height: 30px !important;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s ease;
            color: white;
            font-size: 24px;
            z-index: 1001;
            padding: 0 !important;
            margin: 0 !important;
        }

        .theme-toggle:hover {
            background: rgba(255,255,255,0.2);
            transform: none !important;
            box-shadow: 0 4px 15px rgba(0,0,0,0.3);
        }

        /* التعديلات الجديدة لتثبيت رأس الإحصائيات */
        .stats-header {
            position: sticky;
            top: 0;
            background: var(--bg-secondary);
            padding: 10px;
            border-radius: 15px;
            box-shadow: 0 5px 15px var(--shadow-color);
            z-index: 10;
            margin-bottom: 20px;
        }
        
        .stats-table-container {
            max-height: calc(100vh - 300px);
            overflow-y: auto;
            margin-top: 20px;
        }
        
        /* مؤشر التحميل */
        .loader {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255,255,255,.3);
            border-radius: 50%;
            border-top-color: #fff;
            animation: spin 1s ease-in-out infinite;
            margin-right: 10px;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        /* شاشة التحميل الكبيرة */
        .global-loader {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 2000;
            display: none;
        }
        
        .big-loader {
            width: 60px;
            height: 60px;
            border: 6px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top-color: white;
            animation: spin 1s ease-in-out infinite;
        }
    </style>
</head>
<body>
    <!-- شاشة التحميل الكبيرة -->
    <div class="global-loader" id="globalLoader">
        <div class="big-loader"></div>
    </div>
    
    <!-- الواجهة الرئيسية -->
    <div class="container">
        <nav class="sidebar">
            <button class="theme-toggle" id="themeToggle">
                <i class="fas fa-moon"></i>
            </button>
            
            <div class="tatle">
                <lable>نظام الإدارة</lable>
            </div>
            <div id="navsButtons"></div>
            <button onclick="showSection('breaks')"><i class="fas fa-coffee"></i>الزمنيات</button>
            <button class="logout-btn" onclick="logout()">
                <i class="fas fa-sign-out-alt"></i>  
            </button>
        </nav>

        <main class="content">
            <!-- الواجهة الرئيسية -->
            <div id="dashboard" class="section active">
                <h2>إدارة الموظفين</h2>
                <div class="form-container">
                    <div class="form-group">
                        <label>اسم الموظف:</label>
                        <input type="text" id="empName" placeholder="أدخل الاسم الكامل">
                    </div>
                    <div class="form-group">
                        <label>نوع العمل:</label>
                        <select id="empType">
                            <option value="فني">فني</option>
                            <option value="جوكر">جوكر</option>
                            <option value="متابع">متابع</option>
                        </select>
                    </div>
                </div>
                <button class="btn btn-primary" id="addEmployeeBtn" onclick="addEmployee()">
                    <i class="fas fa-plus"></i>إضافة موظف
                </button>
                
                <!-- جدول الموظفين -->
                <h3>قائمة الموظفين</h3>
                <table id="employeeTable" class="data-table">
                    <thead>
                        <tr>
                            <th>اسم الموظف</th>
                            <th>نوع العمل</th>
                            <th>الإجراءات</th>
                        </tr>
                    </thead>
                    <tbody>
                        <!-- سيتم ملء الجدول ديناميكيًا -->
                    </tbody>
                </table>
            </div>
            
            <!-- قسم الإجازات -->
            <div id="leaves" class="section">
                <h2>إدارة الإجازات</h2>
                <div class="daily-tabs" id="leaveTabs"></div>
                <div class="form-container">
                    <div class="form-group">
                        <label>الموظف:</label>
                        <select class="emp-select" id="leaveEmp"></select>
                    </div>
                    <div class="form-group">
                        <label>تاريخ البدء:</label>
                        <input type="date" id="leaveStart">
                    </div>
                    <div class="form-group">
                        <label>تاريخ الانتهاء:</label>
                        <input type="date" id="leaveEnd">
                    </div>
                    <div class="form-group">
                        <label>نوع الإجازة:</label>
                        <select id="leaveType">
                            <option value="يومية">يومية</option>
                            <option value="مفتوحة">مفتوحة</option>
                            <option value="بدون راتب">بدون راتب</option>
                        </select>
                    </div>
                </div>
                <button class="btn btn-primary" id="addLeaveBtn" onclick="addLeave()">
                    <i class="fas fa-plus"></i>إضافة إجازة
                </button>
                <table class="data-table" id="leavesList"></table>
            </div>

            <!-- قسم الزمنيات -->
            <div id="breaks" class="section">
                <h2>إدارة الزمنيات</h2>
                <input type="text" id="breaksSearch" placeholder="ابحث باسم الموظف..." 
                    onkeyup="searchBreaks()" class="search-input">
                <div class="form-container">
                    <div class="form-group">
                        <label>الموظف:</label>
                        <select class="emp-select" id="breakEmp"></select>
                    </div>
                    <div class="form-group">
                        <label>مدة الزمنية:</label>
                        <select id="breakDuration">
                            <option value="0.25">ربع ساعة</option>
                            <option value="0.5">نصف ساعة</option>
                            <option value="1">ساعة واحدة</option>
                            <option value="2">ساعتان</option>
                            <option value="3">3 ساعات</option>
                            <option value="4">4 ساعات</option>
                            <option value="5">5 ساعات</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>التاريخ والوقت:</label>
                        <input type="datetime-local" id="breakDateTime">
                    </div>
                </div>
                <button class="btn btn-primary" id="addBreakBtn" onclick="addBreak()">
                    <i class="fas fa-plus"></i>إضافة زمنية
                </button>
                
                <h3>سجل الزمنيات</h3>
                <table class="data-table" id="breaksTable">
                    <thead>
                        <tr>
                            <th>الموظف</th>
                            <th>المدة (ساعات)</th>
                            <th>التاريخ والوقت</th>
                            <th>الإجراءات</th>
                        </tr>
                    </thead>
                    <tbody>
                        <!-- سيتم ملؤه ديناميكيًا -->
                    </tbody>
                </table>
            </div>

            <!-- قسم المخالفات -->
            <div id="violations" class="section">
                <h2>إدارة المخالفات</h2>
                <div class="daily-tabs" id="violationTabs"></div>
                <div class="form-container">
                    <div class="form-group">
                        <label>الموظف:</label>
                        <select class="emp-select" id="violationEmp"></select>
                    </div>
                    <div class="form-group">
                        <label>تاريخ المخالفة:</label>
                        <input type="date" id="violationDate">
                    </div>
                    <div class="form-group">
                        <label>سبب المخالفة:</label>
                        <textarea id="violationReason" rows="3"></textarea>
                    </div>
                    <div class="form-group">
                        <label>شدة المخالفة:</label>
                        <select id="violationSeverity">
                            <option value="خفيفة">خفيفة</option>
                            <option value="متوسطة">متوسطة</option>
                            <option value="شديدة">شديدة</option>
                        </select>
                    </div>
                </div>
                <button class="btn btn-primary" id="addViolationBtn" onclick="addViolation()">
                    <i class="fas fa-plus"></i>إضافة مخالفة
                </button>
                <table class="data-table" id="violationsList"></table>
            </div>

            <!-- قسم المكافآت -->
            <div id="rewards" class="section">
                <h2>إدارة المكافآت</h2>
                <div class="daily-tabs" id="rewardTabs"></div>
                <div class="form-container">
                    <div class="form-group">
                        <label>الموظف:</label>
                        <select class="emp-select" id="rewardEmp"></select>
                    </div>
                    <div class="form-group">
                        <label>تاريخ المكافأة:</label>
                        <input type="date" id="rewardDate">
                    </div>
                    <div class="form-group">
                        <label>سبب المكافأة:</label>
                        <textarea id="rewardReason" rows="3"></textarea>
                    </div>
                </div>
                <button class="btn btn-primary" id="addRewardBtn" onclick="addReward()">
                    <i class="fas fa-plus"></i>إضافة مكافأة
                </button>
                <table class="data-table" id="rewardsList"></table>
            </div>

            <!-- قسم الإحصائيات -->
            <div id="stats" class="section">
                <!-- التعديل الجديد: رأس ثابت للإحصائيات -->
                <div class="stats-header">
                    <h2>الإحصائيات الشاملة</h2>
                    <div class="form-container">
                        <div class="form-group">
                            <input type="text" id="statsSearch" placeholder="ابحث بالموظف أو النوع أو التاريخ..." 
                                onkeyup="searchStats()" class="search-input">
                        </div>
                    </div>
                </div>
                
                <div class="stats-table-container">
                    <button class="btn btn-success export-btn" onclick="exportStats()"><i class="fas fa-file-excel"></i>تصدير إلى Excel</button>
                    <table class="data-table" id="statsTable">
                        <thead>
                            <tr>
                                <th>الموظف</th>
                                <th>النوع</th>
                                <th>التاريخ</th>
                                <th>التفاصيل</th>
                                <th>الإجراءات</th>
                            </tr>
                        </thead>
                        <tbody id="statsBody"></tbody>
                    </table>
                </div>
            </div>
        </main>
    </div>

    <script>
        // === تكوين Firebase ===
    const firebaseConfig = {
  apiKey: "AIzaSyAEH9ys-thWboZoYL1B0Hs2H4qILDXgzys",
  authDomain: "wifi-f221e.firebaseapp.com",
  projectId: "wifi-f221e",
  storageBucket: "wifi-f221e.firebasestorage.app",
  messagingSenderId: "100422358110",
  appId: "1:100422358110:web:5ba598af65883b23f550cf",
  databaseURL: "https://wifi-f221e-default-rtdb.asia-southeast1.firebasedatabase.app",

};
        
        
        // تهيئة Firebase
        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();
        const auth = firebase.auth();
        
        // شاشة التحميل
        const globalLoader = document.getElementById('globalLoader');
        
        // إظهار شاشة التحميل
        function showGlobalLoader() {
            globalLoader.style.display = 'flex';
        }
        
        // إخفاء شاشة التحميل
        function hideGlobalLoader() {
            globalLoader.style.display = 'none';
        }
        
        // === مراجع قاعدة البيانات ===
        const dbRef = {
            employees: database.ref('employees'),
            leaves: database.ref('leaves'),
            violations: database.ref('violations'),
            rewards: database.ref('rewards'),
            breaks: database.ref('breaks')
        };
        
        // === نظام المصادقة ===
        // التحقق من حالة تسجيل الدخول
        showGlobalLoader();
        auth.onAuthStateChanged(user => {
            if (!user) {
                // إذا لم يكن المستخدم مسجل الدخول، توجيهه إلى صفحة تسجيل الدخول
                window.location.href = 'login.html';
            } else {
                // تهيئة التطبيق بعد التأكد من تسجيل الدخول
                initializeApp();
            }
        });

        // === تهيئة التطبيق بعد الدخول ===
        async function initializeApp() {
            try {
                // تطبيق الوضع الداكن إذا كان مفعلًا
                let darkMode = localStorage.getItem('darkMode') === 'true';
                if (darkMode) {
                    document.body.classList.add('dark-mode');
                    document.getElementById('themeToggle').innerHTML = '<i class="fas fa-sun"></i>';
                }
                
                // جلب البيانات من Firebase
                await loadDataFromFirebase();
                
                updateEmployeeDropdowns();
                refreshAllSections();
                createDailyTabs();
                updateEmployeeTable();
                
                // إعداد مستمعات للتحديثات في الوقت الحقيقي
                setupRealtimeListeners();
                
                hideGlobalLoader();
            } catch (error) {
                console.error('خطأ في تهيئة التطبيق:', error);
                hideGlobalLoader();
                alert('حدث خطأ في تحميل التطبيق. يرجى تحديث الصفحة.');
            }
        }

        // جلب البيانات من Firebase
        async function loadDataFromFirebase() {
            try {
                const snapshot = await dbRef.employees.once('value');
                employees = snapshot.val() ? Object.values(snapshot.val()) : [];
                
                const snapshotLeaves = await dbRef.leaves.once('value');
                leaves = snapshotLeaves.val() ? Object.values(snapshotLeaves.val()) : [];
                
                const snapshotViolations = await dbRef.violations.once('value');
                violations = snapshotViolations.val() ? Object.values(snapshotViolations.val()) : [];
                
                const snapshotRewards = await dbRef.rewards.once('value');
                rewards = snapshotRewards.val() ? Object.values(snapshotRewards.val()) : [];
                
                const snapshotBreaks = await dbRef.breaks.once('value');
                breaks = snapshotBreaks.val() ? Object.values(snapshotBreaks.val()) : [];
            } catch (error) {
                console.error('خطأ في جلب البيانات:', error);
                throw error;
            }
        }

        // إعداد مستمعات للتحديثات في الوقت الحقيقي
        function setupRealtimeListeners() {
            dbRef.employees.on('value', (snapshot) => {
                employees = snapshot.val() ? Object.values(snapshot.val()) : [];
                updateEmployeeTable();
                updateEmployeeDropdowns();
            });
            
            dbRef.leaves.on('value', (snapshot) => {
                leaves = snapshot.val() ? Object.values(snapshot.val()) : [];
                refreshLeaves();
                updateStats();
            });
            
            dbRef.violations.on('value', (snapshot) => {
                violations = snapshot.val() ? Object.values(snapshot.val()) : [];
                refreshViolations();
                updateStats();
            });
            
            dbRef.rewards.on('value', (snapshot) => {
                rewards = snapshot.val() ? Object.values(snapshot.val()) : [];
                refreshRewards();
                updateStats();
            });
            
            dbRef.breaks.on('value', (snapshot) => {
                breaks = snapshot.val() ? Object.values(snapshot.val()) : [];
                refreshBreaksTable();
            });
        }

        // تسجيل الخروج
        function logout() {
            showGlobalLoader();
            auth.signOut().then(() => {
                window.location.href = 'login.html';
            }).catch(error => {
                console.error('خطأ في تسجيل الخروج:', error);
                hideGlobalLoader();
                alert('حدث خطأ أثناء تسجيل الخروج. يرجى المحاولة مرة أخرى.');
            });
        }

        // تبديل الوضع الداكن/الفاتح
        function toggleDarkMode() {
            let darkMode = localStorage.getItem('darkMode') === 'true';
            darkMode = !darkMode;
            document.body.classList.toggle('dark-mode', darkMode);
            localStorage.setItem('darkMode', darkMode);
            
            const themeIcon = document.getElementById('themeToggle');
            if (darkMode) {
                themeIcon.innerHTML = '<i class="fas fa-sun"></i>';
            } else {
                themeIcon.innerHTML = '<i class="fas fa-moon"></i>';
            }
        }

        // إعداد أزرار التنقل
        const navsButtons = document.getElementById('navsButtons');
        navsButtons.innerHTML = `<button onclick="showSection('dashboard')"><i class="fas fa-home"></i>الواجهة الرئيسية</button>
                <button onclick="showSection('leaves')"><i class="fas fa-calendar-alt"></i>الإجازات</button>
                <button onclick="showSection('violations')"><i class="fas fa-exclamation-triangle"></i>المخالفات</button>
                <button onclick="showSection('rewards')"><i class="fas fa-award"></i>المكافآت</button>
                <button onclick="showSection('stats')"><i class="fas fa-chart-bar"></i>الإحصائيات</button>`;

        // نظام التخزين
        let employees = [];
        let leaves = [];
        let violations = [];
        let rewards = [];
        let breaks = [];
        let currentTab = new Date().toISOString().split('T')[0];
        let editingEntry = null;

        // وظائف العرض العامة
        function showSection(sectionId) {
            document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
            document.getElementById(sectionId).classList.add('active');
            resetForms();
        }

        function resetForms() {
            editingEntry = null;
            document.querySelectorAll('.form-container input, .form-container select, .form-container textarea').forEach(el => {
                if(el.tagName === 'SELECT') el.selectedIndex = 0;
                else el.value = '';
            });
        }

        // معالجة اضافة موظفين للواجهة الرئيسية 
        async function addEmployee() {
            const name = document.getElementById('empName').value.trim();
            const type = document.getElementById('empType').value;
            
            if(!name) return;
            
            const btn = document.getElementById('addEmployeeBtn');
            const originalText = btn.innerHTML;
            btn.innerHTML = '<div class="loader"></div>جاري الإضافة...';
            btn.disabled = true;
            
            try {
                const employee = { id: Date.now(), name, type };
                
                // إضافة إلى Firebase
                await dbRef.employees.child(employee.id).set(employee);
                
                // إضافة إلى المصفوفة المحلية
                employees.push(employee);
                
                document.getElementById('empName').value = '';
                refreshAllSections();
                updateEmployeeDropdowns();
                updateEmployeeTable();
            } catch (error) {
                console.error('خطأ في إضافة موظف:', error);
                alert('حدث خطأ أثناء إضافة الموظف.');
            } finally {
                btn.innerHTML = originalText;
                btn.disabled = false;
            }
        }

        // تحديث جدول الموظفين
        function updateEmployeeTable() {
            const tableBody = document.getElementById('employeeTable').getElementsByTagName('tbody')[0];
            tableBody.innerHTML = '';
            
            if (employees && employees.length > 0) {
                employees.forEach(employee => {
                    const row = tableBody.insertRow(0);
                    row.innerHTML = `
                        <td>${employee.name}</td>
                        <td>${employee.type}</td>
                        <td>
                            <button class="btn btn-primary" onclick="editEmployee(${employee.id})"><i class="fas fa-edit"></i> تعديل</button>
                            <button class="btn btn-danger" onclick="deleteEmployee(${employee.id})"><i class="fas fa-trash"></i> حذف</button>
                        </td>
                    `;
                });
            } else {
                const row = tableBody.insertRow(0);
                const cell = row.insertCell(0);
                cell.colSpan = 3;
                cell.textContent = 'لا يوجد موظفين';
            }
        }

        // تعديل موظف
        function editEmployee(id) {
            const employee = employees.find(emp => emp.id === id);
            if (employee) {
                document.getElementById('empName').value = employee.name;
                document.getElementById('empType').value = employee.type;
                editingEntry = employee;
                updateEmployeeDropdowns();
            }
        }

        // حذف موظف
        async function deleteEmployee(id) {
            if (!confirm('هل أنت متأكد من حذف هذا الموظف؟')) return;
            
            try {
                // حذف من Firebase
                await dbRef.employees.child(id).remove();
                
                // حذف من المصفوفات المحلية
                employees = employees.filter(emp => emp.id !== id);
                leaves = leaves.filter(leave => leave.empId != id);
                violations = violations.filter(violation => violation.empId != id);
                rewards = rewards.filter(reward => reward.empId != id);
                breaks = breaks.filter(b => b.empId != id);
                
                // حذف السجلات المرتبطة من Firebase
                await Promise.all([
                    deleteRelatedRecords(dbRef.leaves, 'empId', id),
                    deleteRelatedRecords(dbRef.violations, 'empId', id),
                    deleteRelatedRecords(dbRef.rewards, 'empId', id),
                    deleteRelatedRecords(dbRef.breaks, 'empId', id)
                ]);
                
                updateEmployeeTable();
                updateEmployeeDropdowns();
                refreshAllSections();
            } catch (error) {
                console.error('خطأ في حذف الموظف:', error);
                alert('حدث خطأ أثناء حذف الموظف.');
            }
        }

        // حذف السجلات المرتبطة من Firebase
        async function deleteRelatedRecords(ref, field, value) {
            try {
                const snapshot = await ref.once('value');
                if (snapshot.exists()) {
                    snapshot.forEach(child => {
                        if (child.val()[field] === value) {
                            ref.child(child.key).remove();
                        }
                    });
                }
            } catch (error) {
                console.error(`خطأ في حذف السجلات المرتبطة: ${error}`);
            }
        }

        // تحديث القوائم المنسدلة للموظفين
        function updateEmployeeDropdowns() {
            const selects = document.querySelectorAll('.emp-select');
            selects.forEach(select => {
                select.innerHTML = '<option value="">اختر الموظف</option>' + 
                    employees.map(e => `<option value="${e.id}">${e.name} - ${e.type}</option>`).join('');
            });

            document.getElementById('breakEmp').innerHTML = 
                '<option value="">اختر الموظف</option>' + 
                employees.map(e => `<option value="${e.id}">${e.name}</option>`).join('');
        }

        //  معالجة اضافة الاجازات
        async function addLeave() {
            const formData = {
                id: editingEntry?.id || Date.now(),
                empId: document.getElementById('leaveEmp').value,
                start: document.getElementById('leaveStart').value,
                end: document.getElementById('leaveEnd').value,
                type: document.getElementById('leaveType').value,
                date: currentTab
            };

            if(!formData.empId || !formData.start || !formData.end) return alert('يرجى ملء جميع الحقول المطلوبة');

            const btn = document.getElementById('addLeaveBtn');
            const originalText = btn.innerHTML;
            btn.innerHTML = '<div class="loader"></div>جاري الإضافة...';
            btn.disabled = true;
            
            try {
                // حفظ في Firebase
                await dbRef.leaves.child(formData.id).set(formData);
                
                // تحديث المصفوفة المحلية
                if(editingEntry) {
                    const index = leaves.findIndex(l => l.id === editingEntry.id);
                    leaves[index] = formData;
                } else {
                    leaves.push(formData);
                }
                
                // refreshLeaves();
                updateStats();
                resetForms();
            } catch (error) {
                console.error('خطأ في إضافة إجازة:', error);
                alert('حدث خطأ أثناء إضافة الإجازة.');
            } finally {
                btn.innerHTML = originalText;
                btn.disabled = false;
            }
        }

        function refreshLeaves() {
            const filtered = leaves.filter(l => l.date === currentTab);
            const tbody = document.getElementById('leavesList');
            tbody.innerHTML = `
                <tr>
                    <th>الموظف</th>
                    <th>النوع</th>
                    <th>من</th>
                    <th>إلى</th>
                    <th>الإجراءات</th>
                </tr>
                ${filtered.map(leave => `
                    <tr>
                        <td>${getEmployeeName(leave.empId)}</td>
                        <td>${leave.type}</td>
                        <td>${leave.start}</td>
                        <td>${leave.end}</td>
                        <td class="action-buttons">
                            <button class="btn btn-primary" onclick="editEntry('leave', ${leave.id})"><i class="fas fa-edit"></i></button>
                            <button class="btn btn-danger" onclick="deleteEntry('leave', ${leave.id})"><i class="fas fa-trash"></i></button>
                        </td>
                    </tr>
                `).join('')}
            `;
        }

        //  معالجة اضافة المخالفات
        async function addViolation() {
            const formData = {
                id: editingEntry?.id || Date.now(),
                empId: document.getElementById('violationEmp').value,
                date: document.getElementById('violationDate').value,
                reason: document.getElementById('violationReason').value,
                severity: document.getElementById('violationSeverity').value,
                created: currentTab
            };

            if(!formData.empId || !formData.date || !formData.reason) return alert('يرجى ملء جميع الحقول المطلوبة');

            const btn = document.getElementById('addViolationBtn');
            const originalText = btn.innerHTML;
            btn.innerHTML = '<div class="loader"></div>جاري الإضافة...';
            btn.disabled = true;
            
            try {
                // حفظ في Firebase
                await dbRef.violations.child(formData.id).set(formData);
                
                // تحديث المصفوفة المحلية
                if(editingEntry) {
                    const index = violations.findIndex(v => v.id === editingEntry.id);
                    violations[index] = formData;
                } else {
                    violations.push(formData);
                }
                
                // refreshViolations();
                updateStats();
                resetForms();
            } catch (error) {
                console.error('خطأ في إضافة مخالفة:', error);
                alert('حدث خطأ أثناء إضافة المخالفة.');
            } finally {
                btn.innerHTML = originalText;
                btn.disabled = false;
            }
        }

        function refreshViolations() {
            const filtered = violations.filter(v => v.created === currentTab);
            const tbody = document.getElementById('violationsList');
            tbody.innerHTML = `
                <tr>
                    <th>الموظف</th>
                    <th>التاريخ</th>
                    <th>السبب</th>
                    <th>الشدة</th>
                    <th>الإجراءات</th>
                </tr>
                ${filtered.map(violation => `
                    <tr class="violation-row">
                        <td>${getEmployeeName(violation.empId)}</td>
                        <td>${violation.date}</td>
                        <td>${violation.reason}</td>
                        <td><span class="violation-badge">${violation.severity}</span></td>
                        <td class="action-buttons">
                            <button class="btn btn-primary" onclick="editEntry('violation', ${violation.id})"><i class="fas fa-edit"></i></button>
                            <button class="btn btn-danger" onclick="deleteEntry('violation', ${violation.id})"><i class="fas fa-trash"></i></button>
                        </td>
                    </tr>
                `).join('')}
            `;
        }

        //  معالجة اضافة المكافئات
        async function addReward() {
            const formData = {
                id: editingEntry?.id || Date.now(),
                empId: document.getElementById('rewardEmp').value,
                date: document.getElementById('rewardDate').value,
                reason: document.getElementById('rewardReason').value,
                created: currentTab
            };

            if(!formData.empId || !formData.date || !formData.reason) return alert('يرجى ملء جميع الحقول المطلوبة');

            const btn = document.getElementById('addRewardBtn');
            const originalText = btn.innerHTML;
            btn.innerHTML = '<div class="loader"></div>جاري الإضافة...';
            btn.disabled = true;
            
            try {
                // حفظ في Firebase
                await dbRef.rewards.child(formData.id).set(formData);
                
                // تحديث المصفوفة المحلية
                if(editingEntry) {
                    const index = rewards.findIndex(r => r.id === editingEntry.id);
                    rewards[index] = formData;
                } else {
                    rewards.push(formData);
                }
                
                // refreshRewards();
                updateStats();
                resetForms();
            } catch (error) {
                console.error('خطأ في إضافة مكافأة:', error);
                alert('حدث خطأ أثناء إضافة المكافأة.');
            } finally {
                btn.innerHTML = originalText;
                btn.disabled = false;
            }
        }

        function refreshRewards() {
            const filtered = rewards.filter(r => r.created === currentTab);
            const tbody = document.getElementById('rewardsList');
            tbody.innerHTML = `
                <tr>
                    <th>الموظف</th>
                    <th>التاريخ</th>
                    <th>السبب</th>
                    <th>الإجراءات</th>
                </tr>
                ${filtered.map(reward => `
                    <tr class="reward-row">
                        <td>${getEmployeeName(reward.empId)}</td>
                        <td>${reward.date}</td>
                        <td>${reward.reason}</td>
                        <td class="action-buttons">
                            <button class="btn btn-primary" onclick="editEntry('reward', ${reward.id})"><i class="fas fa-edit"></i></button>
                            <button class="btn btn-danger" onclick="deleteEntry('reward', ${reward.id})"><i class="fas fa-trash"></i></button>
                        </td>
                    </tr>
                `).join('')}
            `;
        }

        // الزمنيات
        async function addBreak() {
            const breakData = {
                id: Date.now(),
                empId: document.getElementById('breakEmp').value,
                duration: parseFloat(document.getElementById('breakDuration').value),
                datetime: document.getElementById('breakDateTime').value,
                addedAt: new Date().toISOString()
            };

            if (!breakData.empId || !breakData.datetime) {
                alert('يرجى ملء جميع الحقول المطلوبة');
                return;
            }

            const btn = document.getElementById('addBreakBtn');
            const originalText = btn.innerHTML;
            btn.innerHTML = '<div class="loader"></div>جاري الإضافة...';
            btn.disabled = true;
            
            try {
                // حفظ في Firebase
                await dbRef.breaks.child(breakData.id).set(breakData);
                
                // تحديث المصفوفة المحلية
                breaks.push(breakData);
                // refreshBreaksTable();
                resetBreakForm();
            } catch (error) {
                console.error('خطأ في إضافة زمنية:', error);
                alert('حدث خطأ أثناء إضافة الزمنية.');
            } finally {
                btn.innerHTML = originalText;
                btn.disabled = false;
            }
        }

        function refreshBreaksTable() {
            const searchTerm = document.getElementById('breaksSearch').value.trim().toLowerCase();
            const tbody = document.querySelector('#breaksTable tbody');
            tbody.innerHTML = '';

            breaks.forEach(b => {
                const emp = employees.find(e => e.id == b.empId);
                if (!emp) return;

                if (searchTerm && !emp.name.toLowerCase().includes(searchTerm)) {
                    return;
                }

                tbody.innerHTML += `
                    <tr>
                        <td>${emp.name}</td>
                        <td>${formatDuration(b.duration)}</td>
                        <td>${new Date(b.datetime).toLocaleString('ar-EG')}</td>
                        <td>
                            <button class="btn btn-danger" onclick="deleteBreak(${b.id})">
                                <i class="fas fa-trash"></i> حذف
                            </button>
                        </td>
                    </tr>
                `;
            });
        }

        function searchBreaks() {
            refreshBreaksTable();
        }

        async function deleteBreak(breakId) {
            if (!confirm('هل تريد حذف هذه الزمنية')) return;
            
            try {
                // حذف من Firebase
                await dbRef.breaks.child(breakId).remove();
                
                // حذف من المصفوفة المحلية
                breaks = breaks.filter(b => b.id !== breakId);
                refreshBreaksTable();
            } catch (error) {
                console.error('خطأ في حذف الزمنية:', error);
                alert('حدث خطأ أثناء حذف الزمنية.');
            }
        }

        function formatDuration(hours) {
            const totalMinutes = hours * 60;
            const hoursPart = Math.floor(totalMinutes / 60);
            const minutesPart = totalMinutes % 60;
            
            let result = '';
            if (hoursPart > 0) result += `${hoursPart} ساعة `;
            if (minutesPart > 0) result += `${minutesPart} دقيقة`;
            return result || '0 دقيقة';
        }

        function resetBreakForm() {
            document.getElementById('breakEmp').value = '';
            document.getElementById('breakDuration').value = '0.25';
            document.getElementById('breakDateTime').value = '';
        }

        // نظام الإحصائيات
        function updateStats() {
            const statsBody = document.getElementById('statsBody');
            const allData = [
                ...leaves.map(l => ({...l, type: 'إجازة', color: '#f8f9fa'})),
                ...violations.map(v => ({...v, type: 'مخالفة', color: '#e74c3c'})),
                ...rewards.map(r => ({...r, type: 'مكافأة', color: '#27ae60'}))
            ];

            statsBody.innerHTML = allData.map(entry => `
                <tr style="background: ${entry.color}20">
                    <td>${getEmployeeName(entry.empId)}</td>
                    <td>${entry.type}</td>
                    <td>${entry.type == 'إجازة' ? entry.start + ' - ' + entry.end : entry.date}</td>
                    <td>${entry.type == 'إجازة' ? 'يومية' : entry.reason || entry.type + ' - ' + entry.severity || ''}</td>
                    <td>
                        <button class="btn btn-danger" onclick="deleteStatEntry('${entry.type}', ${entry.id})">
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                </tr>
            `).join('');
        }

        async function deleteStatEntry(type, id) {
            try {
                switch(type) {
                    case 'إجازة': 
                        // حذف من Firebase
                        await dbRef.leaves.child(id).remove();
                        
                        // تحديث المصفوفة المحلية
                        leaves = leaves.filter(l => l.id !== id);
                        break;
                    case 'مخالفة':
                        // حذف من Firebase
                        await dbRef.violations.child(id).remove();
                        
                        // تحديث المصفوفة المحلية
                        violations = violations.filter(v => v.id !== id);
                        break;
                    case 'مكافأة':
                        // حذف من Firebase
                        await dbRef.rewards.child(id).remove();
                        
                        // تحديث المصفوفة المحلية
                        rewards = rewards.filter(r => r.id !== id);
                        break;
                }
                refreshAllSections();
            } catch (error) {
                console.error('خطأ في حذف السجل:', error);
                alert('حدث خطأ أثناء حذف السجل.');
            }
        }

        // الوظائف المساعدة
        function getEmployeeName(empId) {
            const emp = employees.find(e => e.id == empId);
            return emp ? emp.name : 'موظف محذوف';
        }

        function editEntry(type, id) {
            let entry;
            switch(type) {
                case 'leave':
                    entry = leaves.find(l => l.id === id);
                    showSection('leaves');
                    break;
                case 'violation':
                    entry = violations.find(v => v.id === id);
                    showSection('violations');
                    break;
                case 'reward':
                    entry = rewards.find(r => r.id === id);
                    showSection('rewards');
                    break;
            }

            if(!entry) return;

            editingEntry = entry;
            const prefix = type === 'leave' ? 'leave' : type === 'violation' ? 'violation' : 'reward';
            
            Object.entries(entry).forEach(([key, value]) => {
                const el = document.getElementById(`${prefix}${key.charAt(0).toUpperCase() + key.slice(1)}`);
                if(el) el.value = value;
            });
        }

        async function deleteEntry(type, id) {
            if(!confirm('هل أنت متأكد من الحذف؟')) return;
            
            try {
                switch(type) {
                    case 'leave':
                        // حذف من Firebase
                        await dbRef.leaves.child(id).remove();
                        
                        // تحديث المصفوفة المحلية
                        leaves = leaves.filter(l => l.id !== id);
                        refreshLeaves();
                        break;
                    case 'violation':
                        // حذف من Firebase
                        await dbRef.violations.child(id).remove();
                        
                        // تحديث المصفوفة المحلية
                        violations = violations.filter(v => v.id !== id);
                        refreshViolations();
                        break;
                    case 'reward':
                        // حذف من Firebase
                        await dbRef.rewards.child(id).remove();
                        
                        // تحديث المصفوفة المحلية
                        rewards = rewards.filter(r => r.id !== id);
                        refreshRewards();
                        break;
                }
                updateStats();
            } catch (error) {
                console.error('خطأ في حذف السجل:', error);
                alert('حدث خطأ أثناء حذف السجل.');
            }
        }

        // نظام التبويبات اليومية
        function createDailyTabs() {
            const dates = Array.from(new Set([
                ...leaves.map(l => l.date),
                ...violations.map(v => v.created),
                ...rewards.map(r => r.created)
            ])).sort((a, b) => new Date(b) - new Date(a));

            const tabContainers = document.querySelectorAll('.daily-tabs');
            tabContainers.forEach(container => {
                container.innerHTML = dates.map(date => `
                    <div class="daily-tab ${date === currentTab ? 'active' : ''}" 
                         onclick="changeTab('${date}')">
                         ${date === new Date().toISOString().split('T')[0] ? 'اليوم' : date}
                    </div>
                `).join('');
            });
        }

        function changeTab(date) {
            currentTab = date;
            createDailyTabs();
            refreshAllSections();
        }

        function refreshAllSections() {
            refreshLeaves();
            refreshViolations();
            refreshRewards();
            updateStats();
            refreshBreaksTable();
        }

        // قسم البحث
        function searchStats() {
            const input = document.getElementById('statsSearch');
            const filter = input.value.toLowerCase();
            const table = document.getElementById('statsTable');
            const trs = table.getElementsByTagName('tr');

            for (let i = 1; i < trs.length; i++) {
                const tds = trs[i].getElementsByTagName('td');
                let shouldShow = false;
                
                for(let j = 0; j < tds.length - 1; j++) {
                    const txtValue = tds[j].textContent || tds[j].innerText;
                    if (txtValue.toLowerCase().includes(filter)) {
                        shouldShow = true;
                        break;
                    }
                }
                
                trs[i].style.display = shouldShow ? '' : 'none';
            }
        }

        // تصدير الإحصائيات
        function exportStats() {
            const data = [
                ['النوع', 'الموظف', 'التاريخ', 'التفاصيل'],
                ...leaves.map(l => ['إجازة', getEmployeeName(l.empId), l.date, l.type]),
                ...violations.map(v => ['مخالفة', getEmployeeName(v.empId), v.date, v.reason]),
                ...rewards.map(r => ['مكافأة', getEmployeeName(r.empId), r.date, r.reason])
            ];

            const ws = XLSX.utils.aoa_to_sheet(data);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "الاحصائيات");
            XLSX.writeFile(wb, "شيت الحضور.xlsx");
        }
        
        // تهيئة التطبيق عند تحميل الصفحة
        document.addEventListener('DOMContentLoaded', () => {
            document.getElementById('themeToggle').addEventListener('click', toggleDarkMode);
        });
    </script>
</body>
</html>